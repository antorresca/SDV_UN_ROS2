<?xml version="1.0"?>
<robot name="sdvun1" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- ================= PROPIEDADES ================= -->
  <xacro:property name="z_base_elev" value="0.075"/>
  <xacro:property name="mass" value="13.676"/>
  <xacro:property name="base_ine_xyz" value="0.00 0.00 0.115223"/>
  <xacro:property name="base_ixx" value="0.207703686"/>
  <xacro:property name="base_iyy" value="0.402153855"/>
  <xacro:property name="base_izz" value="0.396408984"/>
  <xacro:property name="base_ixy" value="0.001009187"/>
  <xacro:property name="base_ixz" value="-0.084130383"/>
  <xacro:property name="base_iyz" value="0.000169123"/>
  <xacro:property name="wheel_radius" value="0.075"/>
  <xacro:property name="x_wheel" value="0.151269"/>
  <xacro:property name="y_wheel" value="0.169"/>
  <xacro:property name="laser_x" value="0.255"/>
  <xacro:property name="laser_y" value="0.0"/>
  <xacro:property name="laser_z" value="${0.334371 + z_base_elev}"/>
  <xacro:property name="z_imu" value="${0.133339 + z_base_elev}"/>
  <xacro:property name="pi_val" value="3.14159265359"/>

  <!-- ================= MACROS ================= -->
  <!-- Visual Macro -->
  <xacro:macro name="visual_m" params="vis_rpy vis_xyz vis_mesh">
    <visual>
      <origin rpy="${vis_rpy}" xyz="${vis_xyz}" />
      <geometry>
        <mesh filename="${vis_mesh}" scale="1.0 1.0 1.0" />
      </geometry>
    </visual>
  </xacro:macro>

  <!-- Inertial Macro -->
  <xacro:macro name="inertial_m" params="mass ine_xyz ixx iyy izz ixy ixz iyz">
    <inertial>
      <mass value="${mass}" />
      <origin xyz="${ine_xyz}" />
      <inertia ixx="${ixx}" iyy="${iyy}" izz="${izz}" ixy="${ixy}" ixz="${ixz}" iyz="${iyz}" />
    </inertial>
  </xacro:macro>

  <!-- Collision Macro -->
  <xacro:macro name="collision_m" params="co_xyz co_rpy col_mesh">
    <collision>
      <origin xyz="${co_xyz}" rpy="${co_rpy}" />
      <geometry>
        <mesh filename="${col_mesh}" scale="1.0 1.0 1.0" />
      </geometry>
    </collision>
  </xacro:macro>

  <!-- Wheel Link Macro -->
  <xacro:macro name="w_link" params="name vis_mesh">
    <link name="${name}">
      <xacro:visual_m vis_rpy="0 0 0" vis_xyz="0 0 0" vis_mesh="${vis_mesh}" />
      <xacro:inertial_m mass="0.416108" ine_xyz="0 0 0" ixx="0.000394174617" iyy="0.000394174618" izz="0.000599770188" ixy="0" ixz="0" iyz="0" />
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder length=".0453" radius=".075" />
        </geometry>
      </collision>
    </link>
  </xacro:macro>

  <!-- Joint Macro -->
  <xacro:macro name="m_joint" params="name type axis origin_xyz origin_rpy parent child">
    <joint name="${name}" type="${type}">
      <origin xyz="${origin_xyz}" rpy="${origin_rpy}" />
      <axis xyz="${axis}" />
      <parent link="${parent}" />
      <child link="${child}" />
    </joint>
  </xacro:macro>

  <!-- Add 4 Wheels Macro -->
  <xacro:macro name="add_4_wheels" params="base_link wheel_visual x_wheel y_wheel z_wheel">
    <!-- Front Right Wheel -->
    <xacro:w_link name="front_right_wheel_link" vis_mesh="${wheel_visual}" />
    <xacro:m_joint name="front_right_wheel_joint" type="continuous" origin_xyz="${x_wheel} -${y_wheel} ${z_wheel}" origin_rpy="0 ${pi_val/2} ${pi_val/2}" axis="0 0 1" parent="${base_link}" child="front_right_wheel_link" />
    <!-- Front Left Wheel -->
    <xacro:w_link name="front_left_wheel_link" vis_mesh="${wheel_visual}" />
    <xacro:m_joint name="front_left_wheel_joint" type="continuous" origin_xyz="${x_wheel} ${y_wheel} ${z_wheel}" origin_rpy="0 ${pi_val/2} -${pi_val/2}" axis="0 0 -1" parent="${base_link}" child="front_left_wheel_link" />
    <!-- Back Right Wheel -->
    <xacro:w_link name="back_right_wheel_link" vis_mesh="${wheel_visual}" />
    <xacro:m_joint name="back_right_wheel_joint" type="continuous" origin_xyz="-${x_wheel} -${y_wheel} ${z_wheel}" origin_rpy="0 ${pi_val/2} ${pi_val/2}" axis="0 0 1" parent="${base_link}" child="back_right_wheel_link" />
    <!-- Back Left Wheel -->
    <xacro:w_link name="back_left_wheel_link" vis_mesh="${wheel_visual}" />
    <xacro:m_joint name="back_left_wheel_joint" type="continuous" origin_xyz="-${x_wheel} ${y_wheel} ${z_wheel}" origin_rpy="0 ${pi_val/2} -${pi_val/2}" axis="0 0 -1" parent="${base_link}" child="back_left_wheel_link" />
  </xacro:macro>

  <!-- ================= LINKS ================= -->
  <!-- Base -->
  <link name="base_link">
    <inertial>
      <mass value="0.001"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.0001"/>
    </inertial>
  </link>

  <!-- Chasis -->
  <link name="chasis_link">
    <visual>
      <geometry>
        <mesh filename="package://sdv_sim/models/sdvun/sdvun1/meshes/base.dae"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://sdv_sim/models/sdvun/sdvun1/meshes/collision.dae"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="${mass}"/>
      <inertia ixx="${base_ixx}" iyy="${base_iyy}" izz="${base_izz}" ixy="${base_ixy}" ixz="${base_ixz}" iyz="${base_iyz}"/>
    </inertial>
  </link>

  <joint name="base_to_chasis_joint" type="fixed">
    <parent link="base_link"/>
    <child link="chasis_link"/>
    <origin xyz="0 0 ${z_base_elev}" rpy="0 0 0"/>
  </joint>

  <!-- ================= RUEDAS ================= -->
  <xacro:add_4_wheels base_link="chasis_link"
                      wheel_visual="package://sdv_sim/models/sdvun/common/meshes/wheel.dae"
                      x_wheel="${x_wheel}" y_wheel="${y_wheel}" z_wheel="${wheel_radius}" />

  <!-- ================= SENSORES ================= -->
  <!-- LIDAR -->
  <link name="laser_sensor_link"/>
  <joint name="laser_joint" type="fixed">
    <parent link="chasis_link"/>
    <child link="laser_sensor_link"/>
    <origin xyz="${laser_x} ${laser_y} ${laser_z}" rpy="0 0 0"/>
  </joint>

  <gazebo reference="laser_sensor_link" >
    <sensor type="ray" name="laser_sensor">
      <update_rate>8</update_rate>
      <ray>
        <scan>
          <horizontal>
            <samples>1440</samples>
            <min_angle>-3.14159274101</min_angle>
            <max_angle>3.14159274101</max_angle>
          </horizontal>
        </scan>
      </ray>
      <plugin name="ign_laser" filename="ignition_ros2_laser_sensor">
        <ros_topi_valc>scan</ros_topi_valc>
        <frame_name>laser_sensor_link</frame_name>
      </plugin>
    </sensor>
  </gazebo>

  <!-- IMU -->
  <link name="imu_sensor_link"/>
  <joint name="imu_joint" type="fixed">
    <parent link="chasis_link"/>
    <child link="imu_sensor_link"/>
    <origin xyz="0 0 ${z_imu}" rpy="0 0 0"/>
  </joint>

  <gazebo reference="imu_sensor_link">
    <sensor type="imu" name="imu_sensor">
      <plugin name="ign_imu" filename="ignition_ros2_imu_sensor">
        <ros_topi_valc>imu</ros_topi_valc>
        <frame_name>imu_sensor_link</frame_name>
      </plugin>
    </sensor>
  </gazebo>

</robot>
